_1

20240407.14:50

지금 뭘 해야 할까?

아두이노 메가로 와이파이 모듈 ESP01(==ESP8266베이스)을 구동해야 한다.



우리 시스템 구성을 보자.

그 전에 로봇청소기의 소프트웨어 시스템과 데이터 경로를 확인해보자.


우선,
로청과 스마트폰(의 앱)이 서로 데이터를 교환해야 한다.
또한 아무리 멀리 떨어져 있어도, 로청의 위치 파악과 명령이 가능하다. (를 간단히 "데이터 교환 가능"하다.)

상용화된 장거리 RF도 현재 안정 거리 15km 정도이다.
답은 하나
->
로컬 네트워크가 아닌 거리상관없는 광범위 인터넷.


준비물
->
인터넷 접속 가능한 스마트폰.
로청의 통신수단으로 와이파이 모듈.

가장 중요한 공인IP...
->
공인 IP만 있으면 장거리 원격 제어를 성공하는 건데,
그 달에 만원 덜 하는 공인 IP를 공짜로 구하는 걸 실패했고, 소프트웨어 관련 외부강사님도 이 학교엔 외부IP 없다고 심심하다고 실증내셨으니,
->
공인 IP인 "인터넷"을 "로컬 네트워크"로 변경.
이외의 작업은 동일하게 한다.

준비물 추가
->
로컬 네트워크 한정해서 웹 서버 제작.
->
와이파이모듈의 펌웨어를 직접 변경해야 한다.
초기 프로토콜로 공장출하된 와이파이모듈을 직접 손봐야 하며, 이는 작년에 알아본 바와 같이 성공 확률이 존재한다,
->
5개, 개당 성공 확률이 50 ~ 80% 였으니까, 하나 쯤은 성공하겠지.
99% 성공하게 하는 장비가 없어서, 알아보면 좋겠다.
성공이긴 한데 부분 실패일 수도 있으니.





->
할 일
1.
위의 시스템을 구상할 확실한 방법/과정 정리.
->
30시간 잡자.

2.
성공확률 높여주는 장비? 뭐 몇 천원 하는 것 같던데,
개인적으로 쓸 수도 있으니, 사비로 하나 주문해두자.

















ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ endline















_2


최종 목표
->
맵 그리는 것.

좌표연산은 어디서 하든 상관없으니, 나중에.

앱인벤터에서 앱 그릴 수 있는지 확인하자.
확장파일 있으려나?


앱인벤터에 캔버스라는 기능이 있다.


앱인벤터의 캔버스를 사용한다면,
->
앱은, 통신으로 좌표값을 주기적으로 받아서,
캔버스를 통해 맵을 표현한다.


캔버스로 맵을 표현하는 것의 예시를 3~5개 보면서, 컴포넌트를 전부 확인하자.

















/*
우선 좌표 연산하는 부분은 제쳐두고.


매핑에서 지도를 그릴 수단으로 두 가지 생각했어.


1.
앱에서 매핑 : 앱인벤터 확장파일
->
확장파일 찾으려는데, 그냥 앱인벤터에 캔버스라는 기능이 있대?
올린 동영상과 사진이 캔버스의 기본적인 기능이야.
좌표 변수화 되고, 도형 뭐든지 그릴 수 있고, 앱인벤터 자체 다기능이 있으니,
->
그냥 가능.



2.
웹에서 매핑.
->
앱에서 대부분의 기능을 웹사이트로 하기 위해서
토스, 당근 어플과 같이 웹뷰 기능을 사용한다.
->
매핑을 웹에서 처리하고, 앱에서 웹을 불러온다.
->
공청/로청 등의 가전기기를 원격 제어할 때 주로 사용되는 가전-서버-어플 데이터 경로 및 구조가 이와 똑같다는 점이 개발에서 큰 의미를 갖는다. (물론 앱인벤터 캔버스 기능과 함께 할 수도 있다.)
->
1. 와이파이모듈로 사용할 ESP8266의 펌웨어를, HTTP protocol을 가진 펌웨어로 변경한다.
2. 매핑 수단은 웹의 HTML이다.
->
이건 알아보는 중.






















ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ endline













_3




ESP8266으로 로컬 네트워크를 사용하는 상황에서,

작년의 상황.
->
외부IP로 접속 가능?



장거리 원격 제어를 하기 위해서 인터넷을 선택했고, 외부 IP를 활용한다.
인터넷을 사용하는 건 맞지만, TCP/IP만으로 가능한가?
아니면 HTTP가 반드시 필요한가?
->
높은 확률로 아님.



ESP8266 와이파이 모듈들끼리 로컬 네트워크를 형성하고 TCP로 데이터를 주고받는 걸 했었어.
여기서는 서버만 soft AP mode를 사용하고,
클라이언트들은 station mode를 사용하면 돼.

이제 로컬 네트워크가 아니라 인터넷을 거쳐서 장거리 통신을 한다면,
? 모르겠네.
이에 대해서는 어떻게 해야 하는지 아주 자세하게 알려줄래?
(매우 자세하게 알려줘.)




1.
로컬 네트워크에서 서버구성 후 데이터 교환 (와이파이모듈은 ESP8266) (형성된 로컬 네트워크 위에서 서버를 구축할 수 있는데, 여기서 네트워크가 스타 토폴로지이므로, AP모듈이 서버를 열면 딱 좋을 뿐이다.)
->
서로 외부 인터넷에 연결할 필요가 없다.
서버모듈은 soft AP mode,
클라모듈은 station mode.
-> 로컬 네트워크 형성됨.
서버를 열고자 하는 모듈은, 포트번호 설정해서 그냥 열고,
서버에 접속하려는 모듈은, (로컬)네트워크상에서 서버의 주소로 접속하면 된다. 내부 IP -> 포트번호


1.
인터넷에서.
->
각각 station mode로 개별 Wi-Fi에 접속한다.
-> 둘 다 넓디 넓은 인터넷에 들어와 있으므로, 네트워크 형성 끝.
서버를 열려는 모듈은, 역시 포트번호 설정해서 그냥 열고,
서버에 접속하려는 모듈은, 공인 IP -> (보안 뚫고) -> 내부 IP -> 포트번호





아두이노 메가 보드로 바로 확인하자.















ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ endline













_4





<
AT+CWMODE=1

OK
AT+CWJAP="SK_WiFiGIGA5173","1702034488"
WIFI CONNECTED
WIFI GOT IP

OK
AT+CIPMUX=1

OK
AT+CIPSERVER=1,50

OK
AT+CIPSTO=7200

OK
>

아두이노 메가에 연결한 ESP8266 서버모듈로,
집에 있는 무선 Wi-Fi에 접속하여 인터넷에 들어가고,
포트번호 50으로 서버를 열었어.

이제 다른 Wi-Fi에 접속한 ESP8266 클라모듈로 이 서버에 접속을 할 건데,
AT+CIPSTART 명령어의 형식을 보면,
ㅡ AT+CIPSTART=<protocol>,<원격 IP>,<원격 포트>        // server에 접속한다.
이렇게 3개 뿐이야.

원래 로컬 네트워크에서는 곧바로 서버의 IP와 포트번호로 접근할 수 있는데,
지금 인터넷을 거치는 상황에서는 우선 외부 IP부터 접근해야 해.

저 명령어에서 IP는 하나 밖에 적을 수 없어.

어떻게 해야 해?

매우 자세하게 알려줄래?










경로를 다시 정리하자.



서버는 인터넷과 연결되어 있다.
TCP/UDP로는 쉽게 전송이 가능하다.

AT+CIPSTART=<protocol-TCP>,<외부 IP>,<외부 포트번호>

여기서 서버에게, 즉 내부 IP와 그의 포트(내부포트)로 접근해야 하는데,

공유기의 포트포워딩이 그 역할을 해준다.

지정한 외부 포트번호로 접근하면, 지정한 내부 IP와 내부포트로 안내하는 역할을 한다.

// 진행할 때 과정을 정확히 하자. 방회벽과 같은 추가적인 공유기 설정이 있을 수도 있어.




내가 그러면 무엇을 해야 하는가??



지금 서버모듈은 인터넷에 연결한 채로 서버를 열었어.

또 다른 ESP8266은 같은 와이파이여도 상관없으니, 인터넷에 연결된 와이파이에 연결하기만 하면 돼.

->
집에 가서 바로 ESP8266+adapter 꺼내서 메가 보드로 실행해보자.














확장파일로 어떻게 서버에 접속했는가?

checkbox
->
debugMessages
hexaStringMode

IP와 포트번호, timeout시간을 적는다.










































ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ endline












_5





웹뷰는 포기. 지금 웹개발은 AI를 쓴다 해도 개념이 너무 없어서 가망이 없어.







집 밖에서 장거리 원격 제어가 가능하려면,
->
인터넷 밖에 없다. (현재 상용화된 RF 최장거리가 고작 15km)

목적 : 작년 캡디에서 구현한 로컬네트워크에 포트포워딩 설정을 추가하여, 인터넷에서 외부 IP를 통해 접속한다.



가전은 집안의 Wi-Fi를 통해, 가전을 제어할 앱이 깔린 스마트폰은 데이터를 통해 각자 인터넷에 연결되어 있다.

네트워크 구성은 끝났다. 어디든 갈 수 있는 "인터넷"에 모두 들어가 있으므로.

이 위에서 마음껏 서버를 구축하면 된다.



어느 네트워크상에서 누구든 서버를 열 수 있다.

서버모듈은 가전, 클라모듈은 앱이라고 하자,
->
포트번호 지정. (원하는 숫자)
->
서버모듈은 자신의 IP와 포트번호를 갖고, 클라모듈은 서버모듈의 IP와 포트번호를 입력하여 서버에 접속한다.




기존의 로컬네트워크에서는 1:1블루투스마냥 같은 공간에서 서로가 아무런 방해 없이 연결되어 있기 때문에, (물론 별도의 보안이 없다면.)
클라모듈은 서버모듈의 IP와 포트번호만 입력하여 서버에 접속하면 된다.

인터넷의 경우, 외부 IP에서부터 파고들어 라우터(공유기)의 방화벽을 거쳐 내부 IP인 클라모듈의 IP로 접근해야 하는데,
클라모듈이 서버에 접속할 때 명령어에 입력하는 칸은 단 두 가지 뿐이다. : IP, portNumber
여기서 라우터의 포트포워딩이 필요하다.

[사진]은 공유기의 포트포워딩 설정과(우리집은 SK broadband) 

// 서비스 포트는, 외부 IP에 대한 외부 포트번호를 말한다.

포트포워딩
==
외부에서 외부 포트번호를 지정하여 내부로 접근하기 위해서,
해당 외부 포트번호에 대하여 특정 내부 IP와 내부 포트번호로 안내하도록 미리 설정하는 것.
->
즉 클라모듈은 외부 IP와 외부 포트번호만 입력하면, 라우터가 알아서 우리가 설정한 내부 IP와 포트번호로 안내해 줄 것이다.





ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ 결론

장거리 원격 제어의 성공을 알림.

실제로 발표할 때는 우리가 만든 가전이 접속할 학교 Wi-Fi를 건들 수가 없으니,
간단하게 같은 Wi-Fi에서 로컬 네트워크로 진행하면 될 것 같다.

웹개발이 가능했다면 라우터를 거쳐서 직접 데이터를 전송할 게 아니라,
애초에 인터넷 안에서 하고싶은거 다 하면 되지만, 그게 안 되면 이 방법이라도.
















ㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡㅡ endline